name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

{%- if values.language == "typescript" %}
env:
  NODE_VERSION: "${{ values.nodeVersion }}"

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${DOLLAR}{{ env.NODE_VERSION }}
          cache: ${{ values.packageManager }}

      - name: Install dependencies
{%- if values.packageManager == "pnpm" %}
        run: |
          corepack enable
          pnpm install --frozen-lockfile
{%- elif values.packageManager == "yarn" %}
        run: yarn install --frozen-lockfile
{%- else %}
        run: npm ci
{%- endif %}

      - name: Run ESLint
{%- if values.packageManager == "pnpm" %}
        run: pnpm lint
{%- elif values.packageManager == "yarn" %}
        run: yarn lint
{%- else %}
        run: npm run lint
{%- endif %}

  typecheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${DOLLAR}{{ env.NODE_VERSION }}
          cache: ${{ values.packageManager }}

      - name: Install dependencies
{%- if values.packageManager == "pnpm" %}
        run: |
          corepack enable
          pnpm install --frozen-lockfile
{%- elif values.packageManager == "yarn" %}
        run: yarn install --frozen-lockfile
{%- else %}
        run: npm ci
{%- endif %}

      - name: Run TypeScript check
{%- if values.packageManager == "pnpm" %}
        run: pnpm typecheck
{%- elif values.packageManager == "yarn" %}
        run: yarn typecheck
{%- else %}
        run: npm run typecheck
{%- endif %}

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${DOLLAR}{{ env.NODE_VERSION }}
          cache: ${{ values.packageManager }}

      - name: Install dependencies
{%- if values.packageManager == "pnpm" %}
        run: |
          corepack enable
          pnpm install --frozen-lockfile
{%- elif values.packageManager == "yarn" %}
        run: yarn install --frozen-lockfile
{%- else %}
        run: npm ci
{%- endif %}

      - name: Run tests
{%- if values.packageManager == "pnpm" %}
        run: pnpm test
{%- elif values.packageManager == "yarn" %}
        run: yarn test
{%- else %}
        run: npm test
{%- endif %}

  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${DOLLAR}{{ env.NODE_VERSION }}
          cache: ${{ values.packageManager }}

      - name: Install dependencies
{%- if values.packageManager == "pnpm" %}
        run: |
          corepack enable
          pnpm install --frozen-lockfile
{%- elif values.packageManager == "yarn" %}
        run: yarn install --frozen-lockfile
{%- else %}
        run: npm ci
{%- endif %}

      - name: Build
{%- if values.packageManager == "pnpm" %}
        run: pnpm build
{%- elif values.packageManager == "yarn" %}
        run: yarn build
{%- else %}
        run: npm run build
{%- endif %}
{%- else %}
env:
  PYTHON_VERSION: "${{ values.pythonVersion }}"

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install ${DOLLAR}{{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: uv pip install -e ".[dev]"

      - name: Run ruff check
        run: uv run ruff check src tests

      - name: Run ruff format check
        run: uv run ruff format --check src tests

  typecheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install ${DOLLAR}{{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: uv pip install -e ".[dev]"

      - name: Run mypy
        run: uv run mypy src

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install ${DOLLAR}{{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: uv pip install -e ".[dev]"

      - name: Run tests
        run: uv run pytest tests -v
{%- endif %}
